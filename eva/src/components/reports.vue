<template>
  <v-app 
    class="reports-app-main" 
    :style="{background: color.back}"
  >
    <header-top @setUsername="setUsername($event)" />
    <v-content>
      <v-container class="main-container container-report">
        <div 
          ref="report"
          class="report-block" 
        >
          <v-card 
            class="static-block" 
            :style="{background: color.backElement, color: color.text}">
            <v-card-title class="static-title">
              <p>Статистика</p>
              <div 
                class="static-divider"
                :style="{background:color.controls}" 
              />
            </v-card-title>
            <v-card-text 
              class="static-overflow-block" 
              :style="{color:color.text}"
            >
              <div 
                v-for="item in rows" 
                :key="item.id" 
                class="static-row"  
                @click="openStatistic(item)" 
                v-html="item.text" 
              />
            </v-card-text>
          </v-card>
          <v-card 
            class="search-block" 
            :style="{background: color.backElement, color: color.text}" 
          >
            <v-card-text 
              class="search-card-block" 
              :style="{background: color.backElement, color: color.text}"
            >
              <div 
                class="loading-divider" 
                :class="{loading:loading}" 
              > 
                <div 
                  class="loading-bar " 
                  :style="{background: color.controls}" 
                />
              </div>
              <v-textarea 
                ref="search" 
                v-model="search.original_spl"  
                solo 
                spellcheck="false" 
                flat 
                no-resize 
                hide-details  
                :rows="rowsCount"
                :style="{background: color.backElement, color: `${color.text} !important`}" 
                placeholder="Введите запрос" 
              />
              <v-tooltip 
                bottom 
                :color="color.controlsActive" 
              >
                <template v-slot:activator="{ on }">
                  <v-btn
                    :color="color.controls"
                    fab
                    dark 
                    small
                    absolute
                    class="play-btn"
                    top
                    right
                    v-on="on"
                    @click="launchSearch"
                  >
                    <v-icon>{{ play }}</v-icon>
                  </v-btn>
                </template>
                <span>Запустить</span>
              </v-tooltip>
              <v-tooltip 
                bottom 
                :color="color.controlsActive"  
              >
                <template v-slot:activator="{ on }">
                  <v-btn
                    :color="color.controls"
                    fab
                    dark
                    small
                    absolute
                    top
                    right
                    v-on="on"
                    @click="openSettings"
                  >
                    <v-icon>{{ gear }}</v-icon>
                  </v-btn>
                </template>
                <span>Настройки</span>
              </v-tooltip>
            </v-card-text>
          </v-card>
          <v-card
            ref="vis" 
            class="static-vis" 
            :style="{background: color.backElement, color: color.text}"
          >
            <v-card-text :style="{color: color.text}">
              <v-card-title class="title-vis">
                <v-tooltip 
                  v-for="i in elements"
                  :key="aboutElem[i].key"
                  bottom 
                  :color="color.controlsActive" 
                  @click="changeTab(i)" 
                >
                  <template v-slot:activator="{ on }">
                    <v-icon 
                      class="title-icon" 
                      :color="aboutElem[i].color"  
                      v-on="on" 
                      @click="changeTab(i)"
                    >
                      {{ aboutElem[i].icon }}
                    </v-icon>
                  </template>
                  <span>{{ aboutElem[i].tooltip }}</span>
                </v-tooltip>
                <div 
                  class="divider-tab" 
                  :style="{background: color.border}" 
                />
              </v-card-title>
              <v-card-text 
                :is="`dash-${i}`" 
                v-for="i in elements"
                v-show="aboutElem[i].show"
                :key="i" 
                :idFrom="i" 
                :colorFrom="color"  
                idDashFrom="reports" 
                :widthFrom="size.width" 
                :heightFrom="size.height" 
                :timeFormatFrom="''" 
                :sizeTileFrom="''" 
                :searchRep="true" 
                :tooltipFrom="tooltipSvg"    
                :dataRestFrom="data"    
              />
              <v-tooltip 
                bottom 
                :color="color.controlsActive"
              >
                <template v-slot:activator="{ on }">
                  <v-icon 
                    v-show="unitedShow" 
                    class="title-icon merge" 
                    :color="unitedData.color" 
                    v-on="on"  
                    @click="changeUnited"
                  >
                    {{ merge }}
                  </v-icon>
                </template>
                <span>Режим отображения</span>
              </v-tooltip>
            </v-card-text>
          </v-card>
          <v-card 
            class="statistic-block" 
            :style="{backgroundColor:color.controlsActive}" 
            :class="{showStatistic:showStatistic}"
          >
            <v-card-text>
              <v-data-table 
                :style="{backgroundColor:color.controlsActive}"
                disable-pagination
                hide-default-footer
                :headers="[{ text: 'value', value: 'value' },{ text: 'count', value: 'count' },{ text: '%', value: '%' }]"
                :items="statistic"
              />
            </v-card-text>
          </v-card>
        </div>
      </v-container> 
    </v-content>
    <footer-bottom />
    <modal-report 
      :colorFrom="color" 
      :modalFrom="modal" 
      :searchFrom="search"
      @cancelModal="cancelModal" 
      @setSearch="setSearch($event)" 
    />
  </v-app>
</template>


<script>

import { mdiPlay, mdiSettings, mdiMerge } from '@mdi/js'
import  settings  from '../js/componentsSettings.js';
import themes from '../js/themeSettings.js';

export default {

  data () {
    return {
      search: {
        parametrs: {}
      },
      play: mdiPlay,
      gear: mdiSettings,
      merge: mdiMerge,
      modal: false,
      loading: false,
      rows: [],
      data: {},
      statistic: [],
      showStatistic: false,
      statisticKey: null,
      curTab: null,
      size: {
        width: 0,
        height: 0,
      },
      aboutElem: {},
      rowsCount: 9,
      shema: {},
      unitedShow: false,
      unitedData: {
        color: '',
        united: false
      },
      color: { },
      tooltipSvg: {
        'texts': [],
        'links': [],
        'buttons': []
      }
    } 
  },
  asyncComputed: {
    async static_rows() {
      if (this.shouldGet) {
        this.data =  await this.getData(`reports-${this.search.sid}`);
        let statistic = '';
        this.rows = [];
        if (this.data.data.length != 0) {
          this.shema = this.data.shema;
          this.data = this.data.data;
          let text = '';
          Object.keys(this.shema).forEach( (item,i) => {
            statistic = this.createStatistic(item);
            text = `${item}&nbsp;&nbsp;&nbsp;[${this.shema[item]}]`;
            this.rows.push({'id': i,'text': text,'static': statistic});
          })
        }
        this.$store.commit('setShould', { idDash: 'reports',  id: 'table', status: false}); 
        return true
      }    
    }, 
  },
  computed: { 
    shouldGet: function() {  // понимаем нужно ли запрашивтаь данные с реста
      return this.$store.getters.getShouldGet({id: 'table', idDash: 'reports'})
    },
    elements: function() {
           
      this.$store.getters.getReportElement.forEach( (item,i) => {
        this.$set(this.aboutElem,item,{});
        if (i == 0) {
          this.$set(this.aboutElem[item],'show',true);
          this.$set(this.aboutElem[item],'color',this.color.controls);
        } else {
          this.$set(this.aboutElem[item],'show',false);
          this.$set(this.aboutElem[item],'color',this.color.text);
        }
        this.$set(this.aboutElem[item],'tooltip',settings.reports[item].tooltip);
        this.$set(this.aboutElem[item],'icon',settings.reports[item].icon);
        this.$set(this.aboutElem[item],'key',i);
      })
      return this.$store.getters.getReportElement
    }, 
    theme: function() {
      return this.$store.getters.getTheme
    }
  },  
  watch: {
    theme: function (theme) {
      this.color = themes[theme];
      
    },
  }, 
  methods: {
    launchSearch: async function() {

      this.search.sid = this.hashCode(this.search.original_spl);

      this.$store.auth.getters.putLog(`Запущен запрос  ${this.search.sid}`);

      this.loading = true;
      let response = await this.$store.getters.getDataApi({search: this.search, idDash: 'reports'});
      // вызывая метод в хранилище  

      if (!response.data || response.data.length == 0) {  // если что-то пошло не так 
        this.loading = false;
        this.$store.commit('setErrorLogs',true);
        this.data = [];
        this.rows = [];
      } else {  // если все нормально
    
        let responseDB = this.$store.getters.putIntoDB(response, this.search.sid, 'reports');
        responseDB
          .then(
            result => {
              let refresh =  this.$store.getters.refreshElements('reports', this.search.sid, );
              this.loading = false;
              this.$store.commit('setReportSearch',this.search);
            },
          );
      }
    },
    setUsername: function(event) {
      this.search.parametrs.username = event;
    },
    hashCode: function(otl) {
      return otl.split('').reduce((prevHash, currVal) =>
        (((prevHash << 5) - prevHash) + currVal.charCodeAt(0))|0, 0);
    },
    getData: function(searсhID) {   // асинхронная функция для получения даных с реста
        
      let db = null;
      //let result = null;

      let request = indexedDB.open("EVA",1);  

      request.onerror = function(event) {
        console.log("error: ",event);
      };

      request.onupgradeneeded = event => {
        console.log('create');
        db = event.target.result;
        if (!db.objectStoreNames.contains('searches')) { // if there's no "books" store
          db.createObjectStore('searches'); // create it
        }

        request.onsuccess = event => {
          db = request.result;
          console.log("successEvent: " + db);
        };
      }
      let promise = new Promise((resolve, reject) => {

        request.onsuccess =  event => {

          db = request.result;

          let transaction = db.transaction("searches"); // (1)

          // получить хранилище объектов для работы с ним
          let searches = transaction.objectStore("searches"); // (2)


          let query = searches.get(String(searсhID)); // (3) return store.get('Ire Aderinokun');


          query.onsuccess = event => { // (4)
            if (query.result) {
              resolve(query.result);
            } else {
              resolve([]);
            }
          };

          query.onerror = function() {
            console.log("Ошибка", query.error);
          };
    

        };    

      });

      return promise
    },
    openSettings: function() {
      this.modal = true;
    },
    cancelModal: function() {
      this.modal = false;
    },
    changeTab: function(elem) {
      if (elem == 'multiLine'){
        this.unitedShow = true;
      } else {
        this.unitedShow = false;
      }
      Object.keys(this.aboutElem).forEach( item => {
        if (item != elem) {
          this.$set(this.aboutElem[item],'show',false);
          this.$set(this.aboutElem[item],'color',this.color.text);
        } else {
          this.$set(this.aboutElem[item],'show',true);
          this.$set(this.aboutElem[item],'color',this.color.controls);
        }
      })
    },
    changeUnited: function() {
      if (!this.unitedData.united) {
        this.unitedData.united = true;
        this.unitedData.color = this.color.controlsActive;
      } else {
        this.unitedData.united = false;
        this.unitedData.color = this.color.controls;
      }
      this.$store.commit('setOptions',  { idDash: 'reports', id: 'multiLine', options: {united: this.unitedData.united} });
    },
    createStatistic: function(key) {
      let how_much = {};
      let result = [];
      let length = this.data.length;
      this.data.forEach( item => {
        if (how_much[item[key]]) {
          how_much[item[key]]++;
        } else {
          how_much[item[key]] = 1 
        }
      })
      Object.keys(how_much).forEach( item => {
                    
        result.push(
          {
            'value': item,
            'count': how_much[item],
            '%': Math.round((how_much[item]*100)/length)
          }
        );
      })
               
      return result 

    },
    setSearch: function(search) {
      this.search = Object.assign({},search);
      this.modal = false;
    },
    openStatistic: function(statistic) {
      if (this.statisticKey == statistic.text) {
        this.showStatistic = !this.showStatistic;
      } else {
        this.showStatistic = true;
        this.statisticKey = statistic.text;
        this.statistic = statistic.static;
      } 
    },
    calcSize: function() {
      let size = this.$refs.vis.$el.getBoundingClientRect();
      this.size.width = Math.round(size.width) - 16;
      this.size.height = Math.round(size.height) - 66;
    },
  },
  mounted() {
    this.search = this.$store.getters.getReportSearch;
    if (this.search.original_spl != '') {
      this.$store.commit('setShould', { idDash: 'reports',  id: 'table', status: true});
    }
    this.calcSize();
    this.$refs.search.$el.addEventListener ("keypress", event =>{
      if (event.ctrlKey && event.keyCode == 13) {
        this.launchSearch();
      }
    });
    this.$refs.report.addEventListener('click', event => {
      if(!event.target.classList.contains('static-row')) {
        this.showStatistic = false;
      }
    })

    if (screen.width > 1920) {
      this.rowsCount = 14;
    } else if (screen.width <= 1440) {
      this.rowsCount = 6;
    }
    this.unitedData.color=  this.color.controls;
    this.color = themes[this.theme];
  } 
}


</script>

<style lang="sass" > 
  
   @import '../sass/reports.sass'
   
</style>