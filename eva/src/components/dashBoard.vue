<template>
  <div
    class="dash-layout"
    :options="String(options)"
    :class="{ show_board: props.differentOptions.visible }"
    :style="{ boxShadow: ` 0 0 5px 5px ${props.optionsBoxShadow}` }"
  >
    <v-card
      class="dash-block"
      :style="{
        background: theme.$main_bg,
        boxShadow: `0 3px 1px -2px ${theme.$main_border},
        0 2px 2px 0 ${theme.$main_border},0 1px 5px 0 ${theme.$main_border}`,
      }"
    >
      <v-card-title
        v-show="element.split('-')[0] === 'singleValue'
          ? settings.showTitle
          : props.disappear"
        class="card-title open_title"
      >
        <div class="name-dash">
          <v-icon
            v-if="dataFromDB"
            class="icon"
            :color="theme.$main_border"
          >
            {{ mdiDatabaseSearch }}
          </v-icon>
          <v-tooltip
            bottom
            :color="theme.$accent_ui_color"
            style="z-index: 100"
          >
            <template v-slot:activator="{ on }">
              <v-icon
                v-show="searchingData"
                class="icon"
                :color="theme.$main_border"
                @click="exportDataCSV"
                v-on="on"
              >
                {{ mdiArrowDownBold }}
              </v-icon>
            </template>
            <span>Скачать результаты</span>
          </v-tooltip>
          <v-icon
            v-show="dataMode"
            class="icon chart"
            :color="theme.$accent_ui_color"
          >
            {{ props.icons[elemIcon] }}
          </v-icon>
          <div class="dash-capture">
            <v-menu
              v-model="nameMenu"
              :nudge-width="100"
              :rounded="false"
              offset-y
              attach
            >
              <v-list class="profile-dropdown--list">
                <div
                  v-for="(item, index) in props.options.titleActions"
                  :key="index"
                >
                  <v-list-item>
                    <v-btn
                      class="profile-dropdown--button"
                      icon
                      @click="urlAction(item)"
                    >
                      <v-icon
                        v-if="!!item.icon"
                        small
                      >
                        {{ item.icon }}
                      </v-icon>
                      {{ item.title || item.name }}
                    </v-btn>
                  </v-list-item>
                </div>
              </v-list>
            </v-menu>
            <div
              v-if="props.edit"
              class="dash-title"
              :style="{ color: theme.$main_text }"
              :class="{
                'dash-title--pointer': props.options.titleActions
                  && props.options.titleActions.length
                  && !excludedFromTitleAcrions
              }"
              @click="nameAction(props.options.titleActions)"
            >
              {{ boardTitle }}
            </div>
            <div
              v-if="props.edit"
              v-show="dataMode"
              class="dash-block-id"
              :style="{ color: theme.$main_text }"
            >
              [ {{ element }} ]
              <span
                v-if="dataSourceId !== ''"
                class="ml-1"
              >
                {{ dataSourceTitle }}
              </span>
            </div>
            <div
              v-if="props.edit"
              v-show="dataMode"
              class="dash-block-sid"
              :style="{
                color: theme.$main_text,
                borderColor: theme.$main_border,
              }"
            >
              {{ props.sid }}
            </div>
            <v-text-field
              v-if="!props.edit"
              v-show="dataMode"
              v-model="props.name"
              clearable
              :color="theme.$accent_ui_color"
              :style="{ color: theme.$title }"
              class="dash-edit-title"
              hide-details
            />
          </div>
        </div>
        <div class="settings-dash-block">
          <div class="settings-dash">
            <v-dialog
              ref="fullScreenModal"
              v-model="bigSizeMode"
              width="100%"
              :fullscreen="isFullScreen"
              style="z-index: 999"
            >
              <template v-slot:activator="{ on: onFullScreen }">
                <v-tooltip
                  bottom
                  :color="theme.$accent_ui_color"
                  :open-delay="tooltipOpenDelay"
                  :disabled="disabledTooltip"
                >
                  <template v-slot:activator="{ on: onTooltip }">
                    <v-icon
                      class="expand"
                      :color="theme.$main_border"
                      v-on="{ ...onFullScreen, ...onTooltip }"
                      @click="bigSizeMode = !bigSizeMode"
                    >
                      {{ props.mdiArrowExpand }}
                    </v-icon>
                  </template>
                  <span>Развернуть</span>
                </v-tooltip>
              </template>
              <div
                class="full-screen-dialog"
                :style="{
                  height: isFullScreen ? '100vh' : '80vh'
                }"
              >
                <v-card
                  class="dash-block"
                  :style="{
                    background: theme.$main_bg,
                    boxShadow: `0 3px 1px -2px ${theme.$main_border},
                    0 2px 2px 0 ${theme.$main_border},0 1px 5px 0 ${theme.$main_border}`,
                  }"
                >
                  <v-card-title
                    v-show="props.disappear"
                    class="card-title open_title"
                  >
                    <div class="name-dash">
                      <v-icon
                        v-if="dataFromDB"
                        class="icon"
                        :color="theme.$main_border"
                      >
                        {{ mdiDatabaseSearch }}
                      </v-icon>
                      <v-icon
                        v-show="dataMode"
                        class="icon chart"
                        :color="theme.$accent_ui_color"
                      >
                        {{ props.icons[elemIcon] }}
                      </v-icon>
                      <div class="dash-capture">
                        <div
                          v-if="props.edit"
                          class="dash-title"
                          :style="{ color: theme.$main_text }"
                        >
                          {{ boardTitle }}
                        </div>
                        <div
                          v-if="props.edit"
                          v-show="dataMode"
                          class="dash-block-id"
                          :style="{ color: theme.$main_text }"
                        >
                          [ {{ element }} ]
                          <span
                            v-if="dataSourceId !== ''"
                            class="ml-1"
                          >
                            {{ dataSourceTitle }}
                          </span>
                        </div>
                        <div
                          v-if="props.edit"
                          v-show="dataMode"
                          class="dash-block-sid"
                          :style="{
                            color: theme.$main_text,
                            borderColor: theme.$main_border,
                          }"
                        >
                          {{ props.sid }}
                        </div>
                        <v-text-field
                          v-if="!props.edit"
                          v-show="dataMode"
                          v-model="props.name"
                          clearable
                          :color="theme.$accent_ui_color"
                          :style="{ color: theme.$title }"
                          class="dash-edit-title"
                          hide-details
                        />
                      </div>
                    </div>
                    <div class="settings-dash-block">
                      <div class="settings-dash">
                        <v-tooltip
                          v-if="isMultiline"
                          bottom
                          :color="theme.$accent_ui_color"
                          :open-delay="tooltipOpenDelay"
                        >
                          <template v-slot:activator="{ on }">
                            <v-icon
                              class="datasource"
                              :color="theme.$main_border"
                              v-on="on"
                              @click="resetRange()"
                            >
                              {{ props.mdiMagnifyMinusOutline }}
                            </v-icon>
                          </template>
                          <span>Сбросить зум</span>
                        </v-tooltip>
                        <v-tooltip
                          bottom
                          :color="theme.$accent_ui_color"
                          :open-delay="tooltipOpenDelay"
                        >
                          <template v-slot:activator="{ on }">
                            <v-icon
                              class="expand"
                              :color="theme.$main_border"
                              v-on="on"
                              @click="toggleBigSize"
                            >
                              {{ props.mdiArrowCollapse }}
                            </v-icon>
                          </template>
                          <span>Свернуть</span>
                        </v-tooltip>
                        <v-tooltip
                          bottom
                          :color="theme.$accent_ui_color"
                          :open-delay="tooltipOpenDelay"
                        >
                          <template v-slot:activator="{ on }">
                            <v-icon
                              class="expand"
                              :color="theme.$main_border"
                              v-on="on"
                              @click="isFullScreen = !isFullScreen"
                            >
                              {{
                                isFullScreen
                                  ? props.mdiFullscreenExit
                                  : props.mdiFullscreen
                              }}
                            </v-icon>
                          </template>
                          <span>{{
                            isFullScreen
                              ? 'Выход из полноэкранного режима'
                              : 'на весь экран'
                          }}</span>
                        </v-tooltip>
                      </div>
                    </div>
                  </v-card-title>

                  <portal-target :name="`${element}`" />
                </v-card>
              </div>
            </v-dialog>
            <v-tooltip
              v-if="isMultiline"
              bottom
              :color="theme.$accent_ui_color"
              :open-delay="tooltipOpenDelay"
            >
              <template v-slot:activator="{ on }">
                <v-icon
                  class="datasource"
                  :color="theme.$main_border"
                  v-on="on"
                  @click="resetRange()"
                >
                  {{ props.mdiMagnifyMinusOutline }}
                </v-icon>
              </template>
              <span>Сбросить зум</span>
            </v-tooltip>
          </div>
          <div
            v-show="dataMode"
            class="settings-dash"
            :class="{ settings_move: props.open_gear }"
          >
            <v-tooltip
              v-if="!excludedFromDataSearches"
              bottom
              :color="theme.$accent_ui_color"
              :open-delay="tooltipOpenDelay"
            >
              <template v-slot:activator="{ on }">
                <v-icon
                  class="datasource"
                  :color="theme.$main_border"
                  v-on="on"
                  @click="switchDS(props)"
                >
                  {{ props.mdiDatabase }}
                </v-icon>
              </template>
              <span>Источник данных</span>
            </v-tooltip>
            <v-tooltip
              v-if="props.edit_icon"
              bottom
              :color="theme.$accent_ui_color"
              :open-delay="tooltipOpenDelay"
            >
              <template v-slot:activator="{ on }">
                <v-icon
                  class="pencil"
                  :color="theme.$main_border"
                  v-on="on"
                  @click="
                    () => {
                      props.edit = false;
                      props.edit_icon = false;
                    }
                  "
                >
                  {{ props.mdiPencil }}
                </v-icon>
              </template>
              <span>Переименовать</span>
            </v-tooltip>
            <v-tooltip
              v-if="!props.edit_icon"
              bottom
              :color="theme.$accent_ui_color"
              :open-delay="tooltipOpenDelay"
            >
              <template v-slot:activator="{ on }">
                <v-icon
                  class="check"
                  :color="theme.$main_border"
                  v-on="on"
                  @click="editName(props)"
                >
                  {{ props.mdiCheckBold }}
                </v-icon>
              </template>
              <span>Переименовать</span>
            </v-tooltip>
            <v-tooltip
              bottom
              :color="theme.$accent_ui_color"
              :disabled="disabledTooltip"
              :open-delay="tooltipOpenDelay"
            >
              <template v-slot:activator="{ on }">
                <v-icon
                  class="option"
                  :color="theme.$main_border"
                  v-on="on"
                  @click="switchOP()"
                >
                  {{ props.mdiSettings }}
                </v-icon>
              </template>
              <span>Настройки</span>
            </v-tooltip>
            <v-tooltip
              bottom
              :color="theme.$accent_ui_color"
              :open-delay="tooltipOpenDelay"
            >
              <template v-slot:activator="{ on }">
                <v-icon
                  class="delete"
                  :color="theme.$main_border"
                  v-on="on"
                  @click="deleteDashBoard(props)"
                >
                  {{ props.mdiTrashCanOutline }}
                </v-icon>
              </template>
              <span>Удалить</span>
            </v-tooltip>
          </div>
        </div>
      </v-card-title>
      <div
        v-if="!props.hideLoad"
        class="loading-block"
      >
        <div
          v-show="props.disappear"
          :style="{ borderColor: theme.$main_border, opacity: '0.2' }"
          class="loading-divider"
          :class="{ loading: loading, noBorder: !dataMode }"
        >
          <div
            class="loading-bar"
            :style="{ background: theme.$primary_button }"
          />
        </div>
      </div>
      <v-card-text
        v-if="!excludedFromDataSearches"
        v-show="!showElement"
        class="card-text"
      >
        <button
          class="selectDS"
          :style="{ color: '#FFFFFF', background: theme.$primary_button }"
          @click="chooseDS(idDash)"
        >
          Выберите источник данных
        </button>
      </v-card-text>
      <v-card-text
        :is="currentElem"
        v-if="showElement || excludedFromDataSearches"
        :full-screen-mode="bigSizeMode"
        custom-class="card-text element-itself"
        :color-from="theme"
        :custom-style="{
          color: theme.$main_text,
          background: 'transparent'
        }"
        :id-from="element"
        :id-dash-from="idDash"
        :data-rest-from="searchData"
        :data-mode-from="dataMode"
        :loading="loading"
        :time-format-from="props.timeFormat"
        :size-tile-from="props.sizeTile"
        :size-from="{
          height: bigSizeMode ? fullScreenHeight : height,
          width: bigSizeMode ? fullScreenWidth : width,
        }"
        :tooltip-from="props.tooltip"
        :width-from="width"
        :height-from="height"
        :options="props.options"
        :current-settings="settings"
        :update-settings="updateSettings"
        :is-full-screen="bigSizeMode"
        :full-screen="bigSizeMode"
        :table-per-page="tablePerPage"
        :table-page="tablePage"
        :selected-pie-index="selectedPieIndex"
        @hideDS="hideDS($event)"
        @setVissible="setVissible($event)"
        @setLoading="setLoading($event)"
        @hideLoading="props.hideLoad = true"
        @SetRange="setRange($event)"
        @resetRange="resetRange($event)"
        @changeSelectPie="changeSelectedPie"
        @update:table-per-page="onTableItemsPerPageChange"
        @update:table-page="onTableIItemsPageChange"
      />
    </v-card>
  </div>
</template>

<script>
import {
  mdiArrowAll,
  mdiArrowCollapse,
  mdiArrowDownBold,
  mdiArrowExpand,
  mdiArrowExpandAll,
  mdiCheckBold,
  mdiChevronDown,
  mdiChevronUp,
  mdiClose,
  mdiCodeTags,
  mdiDatabase,
  mdiDatabaseSearch,
  mdiMagnifyMinusOutline,
  mdiPencil,
  mdiSettings,
  mdiTrashCanOutline,
  mdiFullscreen,
  mdiFullscreenExit,
} from '@mdi/js';
import settings from '../js/componentsSettings';
import visualisation from '../js/visualisationCRUD';

export default {
  name: 'DashBoard',
  props: {
    width: {
      type: Number,
      required: true,
    },
    height: {
      type: Number,
      required: true,
    },
    idDashFrom: {
      type: String,
      required: true,
    },
    dataElemFrom: {
      type: String,
      required: true,
    },
    dataModeFrom: {
      type: Boolean,
      default: false,
    },
    dataPageFrom: {
      type: String,
      required: true,
    },
    loading: {
      type: Boolean,
      default: false,
    },
    searchData: {
      type: Array,
      default: () => ([]),
    },
    dataSourceId: {
      type: [String, Number],
      default: '',
    },
    tooltipOpenDelay: {
      type: Number,
      default: 500,
    },
  },
  data() {
    return {
      tablePerPage: 100,
      tablePage: 1,
      dataFromDB: true,
      mdiDatabaseSearch,
      mdiArrowDownBold,
      bigSizeMode: false,
      isFullScreen: false,
      disabledTooltip: false,
      settings: {
        showTitle: true,
      },
      props: {
        id: '',
        name: '',
        mdiPencil,
        mdiCheckBold,
        mdiClose,
        mdiArrowAll,
        mdiArrowExpandAll,
        mdiCodeTags,
        mdiTrashCanOutline,
        mdiMagnifyMinusOutline,
        mdiDatabase,
        mdiSettings,
        mdiChevronUp,
        mdiChevronDown,
        mdiArrowExpand,
        mdiArrowCollapse,
        mdiFullscreen,
        mdiFullscreenExit,
        icons: {},
        edit: true,
        edit_icon: true,
        move_elem: true,
        resize_elem: true,
        datasource_elem: true,
        showOptions: true,
        arrow_coral: 'controlsInsideDash',
        resize_arrow_coral: 'controlsInsideDash',
        code_coral: 'fill:teal',
        transition: true,
        element: '',
        page: '',
        dataRest: [],
        loading: false,
        open_gear: true,
        arrow: {
          direct: 'down',
          elem: mdiChevronDown,
        },
        open_title: false,
        options: {
          visible: true,
          change: false,
          level: 1,
          boxShadow: false,
        },
        optionsBoxShadow: 'transparent',
        differentOptions: {
          visible: true,
        },
        disappear: true,
        timeFormat: '',
        sizeTile: {},
        hideLoad: false,
        tooltip: {},
        metricsMulti: [],
      },
      selectedPieIndex: -1,
      tuneValue: '',
      tuneSliderValue: '',
      nameMenu: false,
      windowHeight: window.innerHeight,
      windowWidth: window.innerWidth,
    };
  },
  computed: {
    getTockens() {
      return this.$store.state[this.idDash].tockens;
    },
    isMultiline() {
      return !!this.element?.includes('multiLine');
    },
    getSelfTockens() {
      return this.getTockens || [];
    },
    boardTitle() {
      if (!this.props || !this.props.name) {
        return this.element;
      }
      let { name } = this.props;

      if (name) {
        this.getSelfTockens.forEach((token) => {
          name = name.replaceAll(`$${token.name}$`, token.value);
        });
      }

      if (name.indexOf('$evaTknLogin$') !== -1) {
        if (this.$jwt.hasToken()) {
          name = name.replaceAll('$evaTknLogin$', this.$jwt.decode().username);
        }
      }
      return name;
    },
    settingsIsOpened() {
      return this.$store.state[this.idDash].modalSettings.status;
    },
    theme() {
      return this.$store.getters.getTheme;
    },
    idDash() {
      return this.idDashFrom;
    },
    element() {
      return this.dataElemFrom;
    },
    dataMode() {
      this.changeOptions(this.dataModeFrom);
      this.setPropDisappear(true);

      return this.dataModeFrom;
    },
    elementType() {
      return this.element.split('-')[0];
    },
    // создаем некий тег элемнета который хотим добавтиь чтобы он был вида типа dash-table
    currentElem() {
      let nameElement = '';
      if (this.element) {
        nameElement = `dash-${this.elementType}`;
      }
      return nameElement;
    },
    elemIcon() {
      let element = '';
      if (this.element) {
        [element] = this.element.split('-');
      }
      return element;
    },
    // понимаем нужно ли переключать элемент между выбором ИС и самими данными '
    showElement() {
      return this.element ? this.$store.state[this.idDash][this.element].switch : false;
    },
    dashFromStore() {
      return this.$store.state[this.idDash][this.element];
    },
    getOptions() {
      if (!this.idDash) {
        return [];
      }
      if (!this.dashFromStore.options) {
        this.$store.commit('setDefaultOptions', { id: this.element, idDash: this.idDash });
      }

      if (!this.dashFromStore?.options.pinned) {
        this.$store.commit('setState', [{
          object: this.dashFromStore.options,
          prop: 'pinned',
          value: false,
        }]);
      }

      return this.dashFromStore.options;
    },
    lastResult() {
      const options = this.getOptions;
      return options.lastResult;
    },
    options() {
      const options = this.getOptions;
      this.setOptionsItems(options);

      if (this.props.options.timeFormat) {
        this.setPropTimeFormat(this.props.options.timeFormat);
      }
      if (this.props.options.widthTile) {
        this.setPropOptionsWidthTile(this.props.options.widthTile);
      } else {
        this.setPropOptionsWidthTile('');
      }
      if (this.props.options.heightTile) {
        this.setPropOptionsHeightTile(this.props.options.heightTile);
      } else {
        this.setPropOptionsHeightTile('');
      }
      if (this.props.options.tooltip) {
        Object.keys(this.props.options.tooltip).forEach((item) => {
          this.setPropTooltips(item, this.props.options.tooltip[item]);
        });
      } else {
        this.setPropTooltips('texts', []);
        this.setPropTooltips('links', []);
        this.setPropTooltips('buttons', []);
      }

      this.setShadow();

      return options.change;
    },
    searchingData() {
      return this.searchData.length > 0;
    },
    dataSourceTitle() {
      return this.$store.state[this.idDash]?.searches?.length > 0
        ? this.$store.state[this.idDash]?.searches
          .find((element) => element?.id === this.dataSourceId)?.sid
        : '';
    },
    fullScreenHeight() {
      if (this.bigSizeMode) {
        if (this.isFullScreen) {
          return this.windowHeight;
        }
        return this.windowHeight * 0.8;
      }
      return this.height;
    },
    fullScreenWidth() {
      if (this.bigSizeMode) {
        if (this.isFullScreen) {
          return this.windowWidth;
        }
        return this.windowWidth * 0.8;
      }
      return this.height;
    },
    excludedFromTitleAcrions() {
      return settings.excludes.fromTitleActions.some((item) => item === this.elementType);
    },
    excludedFromDataSearches() {
      return settings.excludes.fromDataSearches.some((item) => item === this.elementType);
    },
  },
  watch: {
    settingsIsOpened(to) {
      setTimeout(() => {
        this.disabledTooltip = to;
      }, to ? 0 : 600);
    },
  },
  mounted() {
    this.props.icons = settings.icons;
    // понимаем какая страница перед нами
    this.page = this.$parent.$el.getAttribute('data-page');
    // получаем имя этой страницы
    this.props.name = this.$store.state[this.idDash][this.element].name_elem;
    if (this.props.options.boxShadow) {
      this.props.optionsBoxShadow = this.theme.$primary_button;
    } else {
      this.props.optionsBoxShadow = 'transparent';
    }
    this.$nextTick(() => {
      window.addEventListener('resize', this.onResize);
    });

    if (this.element.includes('textarea') || this.element.includes('button')) {
      this.$store.commit('setSwitch', {
        idDash: this.idDash,
        status: true,
        id: this.element,
      });
    }

    const elements = this.dashFromStore
      ?.options?.titleActions?.filter((elem) => elem.type === 'modal');

    if (elements?.length > 0) {
      elements.forEach((element) => {
        if (!this.$store.state[this.idDash]?.[element.elemName]) {
          visualisation.create({
            element: element.tool,
            spaceName: element.type,
            idDash: this.idDash,
          });
        }
      });
    }
  },
  beforeDestroy() {
    const elements = this.dashFromStore
      ?.options?.titleActions?.filter((elem) => elem.type === 'modal');
    if (elements?.length > 0) {
      elements.forEach((element) => {
        const nameElem = this.dashFromStore[element.elemName]?.name_elem;
        visualisation.delete({
          idDash: this.idDash,
          id: element.elemName,
          name: nameElem,
          spaceName: element.type,
        });
      });
    }
  },
  methods: {
    changeSelectedPie(val) {
      this.selectedPieIndex = val;
    },
    onTableIItemsPageChange(page) {
      this.tablePage = page;
    },
    onTableItemsPerPageChange(perPage) {
      this.tablePerPage = perPage;
    },
    setOptionsItems(options) {
      Object.keys(options).forEach((item) => {
        this.props.options[item] = options[item];
      });
    },
    setPropDisappear(val) {
      this.props.disappear = val;
    },
    setPropTimeFormat(val) {
      this.props.timeFormat = val;
    },
    setPropOptionsWidthTile(val) {
      this.$set(this.props.sizeTile, 'width', val);
    },
    setPropOptionsHeightTile(val) {
      this.$set(this.props.sizeTile, 'height', val);
    },
    setPropTooltips(item, value) {
      this.$set(this.props.tooltip, item, value);
    },
    onResize() {
      this.windowWidth = window.innerWidth;
      this.windowHeight = window.innerHeight;
    },
    updateSettings(localSettings) {
      this.settings = JSON.parse(JSON.stringify(localSettings));
    },

    // изменяем имя элемнета
    editName(props) {
      props.edit = true;
      props.edit_icon = true;

      this.$store.commit('setNameDash', {
        name: props.name,
        id: this.element,
        idDash: this.idDash,
      });
    },
    // открываем модальное окно с выбором ИС (источник данных)
    chooseDS() {
      this.$store.commit('setModalSearch', {
        id: this.idDash,
        status: true,
        elem: this.element,
      });
    },
    // переключаем между режимами выбора данных и их отображением
    switchDS() {
      const status = !this.showElement;
      this.$store.commit('setSwitch', {
        idDash: this.idDash,
        status,
        id: this.element,
      });
    },
    switchOP() {
      this.$store.dispatch('openModalSettings', {
        path: this.idDash,
        element: this.element,
        titles: this.searchData[0] ? Object.keys(this.searchData[0]) : [],
      });
    },
    setShadow() {
      if (this.props.options.boxShadow) {
        this.props.optionsBoxShadow = this.theme.$primary_button;
      } else {
        this.props.optionsBoxShadow = 'transparent';
      }
    },
    setLoading(event) {
      if (this.element.indexOf('button') !== -1) {
        this.props.hideLoad = !event;
      }
      this.props.loading = event;
    },
    // вызываем окно для удаления элемнета
    deleteDashBoard(props) {
      this.$store.commit('setModalDelete', {
        id: this.idDash,
        status: true,
        elem: this.element,
        name: props.name,
        page: this.dataPageFrom,
      });
    },
    openTitle() {
      // открываем закрываем шапку элемнета
      if (this.props.arrow.direct === 'up') {
        this.props.arrow.elem = this.props.mdiChevronDown;
        this.props.arrow.direct = 'down';
      } else {
        this.props.arrow.elem = this.props.mdiChevronUp;
        this.props.arrow.direct = 'up';
      }
      this.props.open_title = !this.props.open_title;
    },
    hideDS() {
      // функция которая для определенного элемента сразу вносит ряд настроек визуализации=
      this.$store.commit('setSwitch', {
        idDash: this.idDash,
        status: true,
        id: this.element,
      }); // сразу переключаем элемнет на отображение данных,
    },
    setVissible({ element, overflow }) {
      if (element.split('-')[0] === 'picker' || element.split('-')[0] === 'guntt') {
        // собственно если элемнет выбора даты и времен
        // поскольку запроса данных никакого не надо
        this.$el.querySelector('.dash-block').style.overflow = overflow; // и еще меняем скрытие элемнета,  чтобы раскрывающийся список вылазхил из него
      }
    },
    changeOptions(mode) {
      const { level } = this.props.options;
      let opacity = 1;
      if (mode) {
        this.props.differentOptions.visible = true;
      } else if (!this.props.options.visible) {
        this.props.differentOptions.visible = false;
        opacity = 0;
      } else {
        this.props.differentOptions.visible = true;
        opacity = 1;
      }
      this.$emit('SetOpacity', opacity);
      this.$emit('SetLevel', level);
    },
    exportDataCSV() {
      const searchId = this.$store.state[this.idDash][this.element].search;
      this.$emit('downloadData', searchId);
    },
    getData(searchID) {
      // асинхронная функция для получения даных с реста
      let db = null;
      const request = indexedDB.open('EVA', 1);
      request.onerror = (event) => {
        console.error('error: ', event);
      };
      request.onupgradeneeded = (event) => {
        // console.log('create');
        db = event.target.result;
        if (!db.objectStoreNames.contains('searches')) {
          // if there's no "books" store
          db.createObjectStore('searches'); // create it
        }
        request.onsuccess = () => {
          db = request.result;
          // console.log(`successEvent: ${db}`);
        };
      };
      return new Promise((resolve) => {
        request.onsuccess = () => {
          db = request.result;
          const transaction = db.transaction('searches'); // (1)
          // получить хранилище объектов для работы с ним
          const searches = transaction.objectStore('searches'); // (2)
          const query = searches.get(String(searchID)); // (3) return store.get('Ire Aderinokun');
          query.onsuccess = () => {
            // (4)
            if (query.result) {
              resolve(query.result);
            } else {
              resolve([]);
            }
          };
          query.onerror = () => {
            console.error('Ошибка', query.error);
          };
        };
      });
    },
    getEvents({ event, partelement }) {
      let result = [];
      if (!this.$store.state[this.idDash].events) {
        this.$store.commit('setState', [{
          object: this.$store.state[this.idDash],
          prop: 'events',
          value: [],
        }]);
        return [];
      }
      if (partelement) {
        result = this.$store.state[this.idDash].events.filter((item) => (
          item.event === event
          && item.element === this.id
          && item.partelement === partelement
        ));
      } else {
        result = this.$store.state[this.idDash].events.filter(
          (item) => item.event === event
            && item.target === this.id,
        );
      }
      return result;
    },
    checkFilter() {
      const events = this.getEvents({
        event: 'OnDataCompare',
      });
      let data = [];
      let incl = false;
      let columnDel = '';
      let event = {};
      this.searchData = [];

      events.forEach((item) => {
        event = { ...{}, ...item };

        if (event.prop === 'filter' && event.value === 'true') {
          data = JSON.parse(JSON.stringify(this.props.dataRest));
          event.row = event.row.replace(/\[|\]/g, '').split(',');

          if (event.column.indexOf('!') !== -1) {
            columnDel = event.column.replace('!', '');
            this.props.dataRest.forEach((itemFil, i) => {
              if (Object.keys(itemFil).includes(columnDel)) {
                delete data[i][columnDel];
              }
            });
          } else {
            let notArr;
            switch (event.compare) {
              case 'equals':
                notArr = event.row.reduce((acc, notElem) => {
                  if (notElem.indexOf('!') !== -1) {
                    return [
                      ...acc,
                      notElem.substr(1),
                    ];
                  }
                  return acc;
                }, []);
                if (event.column !== '') {
                  data = data.filter((itemFil) => {
                    if (notArr.length !== 0) {
                      return !notArr.includes(String(itemFil[event.column])) ? itemFil : false;
                    }
                    return event.row.includes(String(itemFil[event.column])) ? itemFil : false;
                  });
                } else {
                  data = data.filter((itemFil) => {
                    if (notArr.length !== 0) {
                      incl = true;
                      Object.values(itemFil).forEach((val) => {
                        if (notArr.includes(String(val))) {
                          incl = false;
                        }
                      });
                    } else {
                      incl = false;
                      Object.values(itemFil).forEach((val) => {
                        if (event.row.includes(String(val))) {
                          incl = true;
                        }
                      });
                    }
                    return incl;
                  });
                }
                break;
              case 'over':
                if (event.column !== '') {
                  data = data.filter((itemFil) => {
                    incl = true;
                    event.row.forEach((row) => {
                      if (
                        parseFloat(itemFil[event.column]) <= parseFloat(row)
                      ) {
                        incl = false;
                      }
                    });
                    return incl;
                  });
                }
                break;
              case 'less':
                if (event.column !== '') {
                  data = data.filter((itemFil) => {
                    incl = true;
                    event.row.forEach((row) => {
                      if (
                        parseFloat(itemFil[event.column]) >= parseFloat(row)
                      ) {
                        incl = false;
                      }
                    });
                    return incl;
                  });
                }
                break;
              case 'in':
                if (event.column !== '') {
                  data = data.filter((itemFil) => !!event.row
                    .includes(String(itemFil[event.column])));
                } else {
                  data = data.filter((itemFil) => {
                    incl = false;
                    Object.values(itemFil).forEach((val) => {
                      if (event.row.includes(String(val))) {
                        incl = true;
                      }
                    });
                    return incl;
                  });
                }
                break;
              case 'between':
                if (event.column !== '') {
                  data = data.filter((itemFil) => {
                    incl = false;
                    let min;
                    let max;
                    if (parseFloat(event.row[0]) > parseFloat(event.row[1])) {
                      [max, min] = event.row;
                    } else {
                      [min, max] = event.row;
                    }
                    if (
                      parseFloat(itemFil[event.column]) > min
                      && parseFloat(itemFil[event.column]) < max
                    ) {
                      incl = true;
                    }
                    return incl;
                  });
                }
                break;
              default:
                break;
            }
          }
          if (this.searchData.length === 0) {
            this.searchData = [...this.searchData, ...data];
            // если в массив результирующем уже что-то было, то надо добавить только новые элементы
          } else {
            // пробегаемся по все мотфильтрвоанным элементам
            data.forEach((itemData) => {
              // переменная которая скажет встречается ли такая строка уже в выборке
              let equal = false;
              // ключи объекта внутри фильтрованного массива
              const keys = Object.keys(itemData);
              // пробегаемся пов сем отфильтрованным данным
              this.searchData.forEach((itemDataRest) => {
                // переменная которая скажет полностью совпал объект внутри результирующего массива
                let equalRest = true;
                // пробегаемся по кажлому полю в объекте
                keys.forEach((key) => {
                  // если значения поля из только что отфильтрованного массива,
                  // не равно значени в уже до этого отфильтрованном массиве,
                  // то значит что строка не полностью совпала, а значит строки не равны
                  if (itemData[key] !== itemDataRest[key]) {
                    // поэтому присваиваем переменной значение мол строки отличаются
                    equalRest = false;
                  }
                });
                // а вот если строка в только
                // что отфлильтрованном массиве полностью совпала
                // со строкой в уже до этого отфильтрованном
                if (equalRest) {
                  // то присваиваем true переменной которай говорит что такая строка уже есть
                  equal = true;
                }
              });
              // и вот если такой строки все же нет
              if (!equal) {
                // то смело добовляем ее в результирующий массив
                this.searchData.push(itemData);
              }
            });
          }
        }
      });
      if (data.length === 0) {
        this.searchData = JSON.parse(JSON.stringify(this.props.dataRest));
      }
    },
    setRange(range) {
      this.$emit('SetRange', range);
    },
    resetRange() {
      this.$emit('ResetRange', this.dataSourceId);
    },
    nameAction(actionList) {
      if (!actionList || this.excludedFromTitleAcrions) return;
      if (actionList.length === 1) {
        this.urlAction(actionList[0]);
      } else {
        this.nameMenu = !this.nameMenu;
      }
    },
    urlAction(action) {
      switch (action.type) {
        case 'modal':
          action.open = true;
          this.$store.commit('setVisualisationModalData', { idDash: this.idDash, data: action });
          break;
        case 'window':
          window.open(action.url, '', 'width=auto,height=auto');
          break;
        default:
          window.open(action.url, action.type);
          break;
      }
    },
    toggleBigSize() {
      this.bigSizeMode = !this.bigSizeMode;
      this.isFullScreen = false;
    },
  },
};
</script>

<style lang="sass">
@import '../sass/dashBoard.sass'
</style>
<style lang="sass">
.settings-dash
    .v-icon:focus::after
        opacity: 0
</style>
