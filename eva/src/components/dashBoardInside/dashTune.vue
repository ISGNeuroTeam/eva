<template>
  <div
      class="dash-map"
      :class="{'full-screen': isFullScreen}"
      :style="{'zoom': needSetField ? 1 : htmlZoom}"
      ref="container"
  >
    <div v-if="needSetField">
      <v-select
          v-model="dataField"
          :dark="isDarkTheme"
          :items="fieldList"
          label="Столбец данных"
          outlined
          class="mt-6"
      ></v-select>
    </div>
    <div
      v-else
      class="flex flex-grow-1 justify-center align-center mt-6"
      :class="{row: vertical}"
    >
      <div class="flex-grow-0">
        <v-slider
            :class="{'slider-vertical': vertical}"
            :dark="isDarkTheme"
            :disabled="loading || values.length === 0"
            v-model="sliderValue"
            :min="0"
            :max="values.length -1"
            :vertical="vertical"
            :color="theme.$primary_button"
            ticks="always"
            @change="onChangeSlider"
        >
        </v-slider>
      </div>
      <div class="pt-4">
        <v-progress-circular
            :rotate="360"
            :size="circularSize"
            :width="circularWidth"
            :value="percentValue"
            :color="loading ? theme.$secondary_border : theme.$primary_button"
        >
          <div v-if="!loading">
            <span class="text-h4">{{ value }}%</span>
          </div>
        </v-progress-circular>
        <div class="pa-4">
          <div>
            <v-btn
                :dark="isDarkTheme"
                :color="theme.$primary_button"
                color="primary"
                :disabled="isMinimumValue"
                @click="addValue(-1)">
              <v-icon>{{ icons.minus }}</v-icon>
            </v-btn>
            <v-btn
                :dark="isDarkTheme"
                :color="theme.$primary_button"
                color="primary"
                class="ml-2"
                :disabled="isMaximumValue"
                @click="addValue(1)">
              <v-icon>{{ icons.plus }}</v-icon>
            </v-btn>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import {mdiMinus, mdiPlus} from "@mdi/js";
import { mapActions, mapGetters, mapMutations } from 'vuex'

export default {
  props: {
    // переменные полученные от родителя
    idFrom: null, // id элемнета (table, graph-2)
    idDashFrom: null, // id дашборда
    dataRestFrom: null, // данные полученые после выполнения запроса
    colorFrom: null, // цветовые переменные
    dataModeFrom: null, // включена ли шапка
    loading: null,
  },
  data() {
    return {
      vertical: true,
      circularSize: 190,
      circularWidth: 20,
      icons: {
        plus: mdiPlus,
        minus: mdiMinus,
      },
      actions: [
        {
          name: 'change',
          capture: []
        },
      ],
      sliderValue: 0,
      dataField: null, // поле с данными
      value: '',
    }
  },
  computed: {
    ...mapGetters([
        'getElementSelected',
        'getElement',
    ]),
    htmlZoom() {
      const size = this.$attrs.heightFrom < this.$attrs.widthFrom
          ? this.$attrs.heightFrom
          : this.$attrs.widthFrom
      return size / 370;
    },
    isFullScreen() {
      return this.$attrs['is-full-screen'];
    },
    storedElement(){
      this.isFullScreen; // << dont remove
      let {idDashFrom, idFrom} = this;
      return this.getElement({
        idDash: idDashFrom,
        id: idFrom
      });
    },
    needSetField() {
      return !this.dataField && !this.loading
    },
    theme: function() {
      return this.colorFrom
    },
    values(){ // значения слайдера
      if (!this.dataField && this.dataRestFrom.length) {
        const keys = Object.keys(this.dataRestFrom[0]).filter(key => key[0] !== '_');
        if (keys.length === 1) {
          this.dataField = keys[0];
        }
      }
      if (!this.dataField) {
        return [];
      }
      const list = this.dataRestFrom
        .map(row => {
          const num = Number.parseFloat(row[this.dataField]);
          return isNaN(num) ? 0 : num
        })
        .sort((a, b) => a - b);
      return list.filter((item, pos) => list.indexOf(item) === pos) // filter duplicates
    },
    minValue(){
      return this.values ? this.values[0] : 0;
    },
    maxValue(){
      return this.values ? this.values[this.values.length -1] : 0
    },
    fractionalValue() {
      return (this.value - this.minValue) / (this.maxValue - this.minValue)
    },
    percentValue() {
      return this.fractionalValue *100
    },
    isMinimumValue() {
      return this.sliderValue <= 0
    },
    isMaximumValue() {
      return this.sliderValue >= this.values.length -1
    },
    isDarkTheme(){
      return this.$store.getters.getThemeTitle.indexOf('light') === -1
    },
    fieldList(){
      if (!this.dataRestFrom.length) {
        return []
      }
      return Object.keys(this.dataRestFrom[0]).filter(key => key[0] !== '_');
    },
    changedInputData() {
      return this.$store.state.store[this.idDashFrom][this.idFrom]?.switch;
    },
  },
  watch: {
    storedElement: {
      handler(element){
        if (element?.selected !== undefined && this.value !== element.selected.elemDeep) {
          this.loadSelectedValue()
        }
      },
      deep: true
    },
    getElementSelected(selected) {
      this.value = selected.elemDeep
    },
    changedInputData(val) {
      this.dataField = null;
      this.value = '';
      this.$store.commit('setSelected', {
        element: 'elemDeep',
        idDash: this.idDashFrom,
        id: this.idFrom,
        value: '',
      });
    },
    values(list) {
      this.detectSliderValue(list)
    },
    sliderValue(value) {
      if (!this.loading && this.values.length > 0) {
        this.value = this.values[value];
      }
    },
    dataField(value) {
      value !== '' && this.$store.commit('setSelected', {
        element: 'elem',
        idDash: this.idDashFrom,
        id: this.idFrom,
        value,
      });
    }
  },
  mounted() {
    this.$store.commit('setActions', {
      actions: this.actions,
      idDash: this.idDashFrom,
      id: this.idFrom
    });
    this.$nextTick(() => {
      this.loadSelectedValue()
    })
  },
  methods: {
    ...mapActions([
        'actionGetElementSelected',
    ]),
    ...mapMutations([
        'setElementSelected',
    ]),
    addValue(val) { // +/- buttons
      this.sliderValue += val
      this.changeValue()
    },
    onChangeSlider(){
      this.changeValue()
    },
    changeValue() {
      this.$nextTick(() => {
        this.setToken()
        this.storeValue()
      })
    },
    storeValue() {
      this.setElementSelected({
        element: 'elemDeep',
        idDash: this.idDashFrom,
        id: this.idFrom,
        value: this.value,
      });
    },
    setToken() {
      this.$store.getters.getTockens(this.idDashFrom).forEach(token => {
        if (token.elem === this.idFrom && token.action === 'change') {
          this.$store.commit('setTocken', {
            tocken: {
              name: token.name,
              action: 'change',
              capture: '',
            },
            idDash: this.idDashFrom,
            value: this.value,
          })
        }
      })
    },
    loadSelectedValue() {
      this.actionGetElementSelected({
        idDash: this.idDashFrom,
        id: this.idFrom
      }).then(selected => {
        if (selected) {
          this.dataField = selected.elem
          this.value = selected.elemDeep
        }
        this.detectSliderValue()
      });
    },
    detectSliderValue(list) {
      let rowNumber = 0
      if (list === undefined) {
        list = this.values
      } else {
        list.forEach(item => {
          if (this.value === '' && this.minValue !== undefined) {
            this.value = this.minValue;
          }
          if (item < this.value) {
            rowNumber++
          }
        })
      }
      this.sliderValue = rowNumber;
      if ((this.value === '' || this.value === null) && list.length) {
        this.value = list[rowNumber]
      }
      this.changeValue()
    }
  },
}
</script>

<style lang="sass">
.dash-map
  color: var(--main_text) !important
  min-width: 360px

  .v-input__append-inner
    margin-top: 16px

  .slider-vertical
    height: 100%
    padding-right: 60px

    .v-slider--vertical
      min-height: 220px

  &.full-screen
    min-width: 690px
</style>