<template>
  <portal
    :to="idFrom"
    :disabled="!fullScreenMode"
  >
    <div
      :style="{
        ...customStyle,
        'width': `${innerSize.width - 22}px`,
        'height': `${innerSize.height - 10}px`,
        background: isPanelBackHide ? 'transparent' : theme.$secondary_bg,
        margin: '0 10px',
      }"
      :class="customClass"
      v-bind="$attrs"
      class="dash-constructor-schemes"
    >
      <div
        class="dash-constructor-schemes__options"
        :class="{
          'dash-constructor-schemes__options--is-keymap-open': hotkeysPanel,
          'dash-constructor-schemes__options--edit-mode': dashboardEditMode,
          'dash-constructor-schemes__options--dnd-panel-is-open': dndPanel,
        }"
      >
        <template v-if="dashboardEditMode">
          <v-tooltip
            bottom
            :z-index="fullScreenMode ? 1005 : 100"
            :color="theme.$accent_ui_color"
          >
            <template v-slot:activator="{ on }">
              <v-btn
                class="ma-2"
                :color="theme.$secondary_text"
                icon
              >
                <v-icon
                  class="control-button edit-icon theme--dark"
                  :style="{ color: theme.$secondary_text }"
                  v-on="on"
                  @click="toggleDnDPanel"
                >
                  {{ dndPanel ? arrowCollapseLeft : arrowCollapseRight }}
                </v-icon>
              </v-btn>
            </template>
            <span>Панель настроек</span>
          </v-tooltip>
          <!--Export-->
          <v-tooltip
            bottom
            :z-index="fullScreenMode ? 1005 : 100"
            :color="theme.$accent_ui_color"
          >
            <template v-slot:activator="{ on }">
              <v-btn
                class="ma-2"
                :color="theme.$secondary_text"
                icon
              >
                <v-icon
                  class="control-button edit-icon theme--dark"
                  :style="{ color: theme.$secondary_text }"
                  v-on="on"
                  @click="exportJSON"
                >
                  {{ fileExportOutline }}
                </v-icon>
              </v-btn>
            </template>
            <span>Экспорт</span>
          </v-tooltip>
          <!--Import-->
          <v-tooltip
            bottom
            :z-index="fullScreenMode ? 1005 : 100"
            :color="theme.$accent_ui_color"
          >
            <template v-slot:activator="{ on }">
              <v-btn
                class="ma-2"
                :color="theme.$secondary_text"
                icon
                v-on="on"
              >
                <v-file-input
                  ref="fileInput"
                  :value="file"
                  :color="theme.$secondary_text"
                  :style="{ color: theme.$secondary_text, fill: theme.$secondary_text }"
                  class="dash-constructor-schemes__file-input"
                  hide-details
                  hide-input
                  :prepend-icon="fileImportOutline"
                  dense
                  outlined
                  label=""
                  @change="updateFile"
                />
              </v-btn>
            </template>
            <span>Импорт</span>
          </v-tooltip>
          <template v-if="searchForBuildScheme">
            <v-tooltip
              :disabled="isLoading"
              bottom
              :z-index="fullScreenMode ? 1005 : 100"
              :color="theme.$accent_ui_color"
            >
              <template v-slot:activator="{ on }">
                <v-btn
                  class="ma-2"
                  :color="theme.$secondary_text"
                  icon
                >
                  <v-icon
                    class="control-button edit-icon theme--dark"
                    :style="{ color: theme.$secondary_text }"
                    v-on="on"
                    @click="openConfirmModal"
                  >
                    {{ cloudDownloadOutlineIcon }}
                  </v-icon>
                </v-btn>
              </template>
              <span>Загрузить с сервера</span>
            </v-tooltip>
          </template>
          <template v-if="dataSelectedNode">
            <v-tooltip
              bottom
              :z-index="fullScreenMode ? 1005 : 100"
              :color="theme.$accent_ui_color"
            >
              <template v-slot:activator="{ on }">
                <v-btn
                  class="ma-2"
                  :color="theme.$secondary_text"
                  icon
                >
                  <bring-to-front
                    class="control-button edit-icon theme--dark"
                    :style="{ color: theme.$secondary_text }"
                    v-on="on"
                    @click="orderTo('toFront')"
                  />
                </v-btn>
              </template>
              <span>На передний план</span>
            </v-tooltip>
            <v-tooltip
              bottom
              :z-index="fullScreenMode ? 1005 : 100"
              :color="theme.$accent_ui_color"
            >
              <template v-slot:activator="{ on }">
                <v-btn
                  class="ma-2"
                  :color="theme.$secondary_text"
                  icon
                >
                  <send-to-back
                    class="control-button edit-icon theme--dark"
                    :style="{ color: theme.$secondary_text }"
                    v-on="on"
                    @click="orderTo('toBack')"
                  />
                </v-btn>
              </template>
              <span>На задний план</span>
            </v-tooltip>
            <v-tooltip
              bottom
              :z-index="fullScreenMode ? 1005 : 100"
              :color="theme.$accent_ui_color"
            >
              <template v-slot:activator="{ on }">
                <v-btn
                  class="ma-2"
                  :color="theme.$secondary_text"
                  icon
                >
                  <bring-forward
                    class="control-button edit-icon theme--dark"
                    :style="{ color: theme.$secondary_text }"
                    v-on="on"
                    @click="orderTo('raise')"
                  />
                </v-btn>
              </template>
              <span>На уровень выше</span>
            </v-tooltip>
            <v-tooltip
              bottom
              :z-index="fullScreenMode ? 1005 : 100"
              :color="theme.$accent_ui_color"
            >
              <template v-slot:activator="{ on }">
                <v-btn
                  class="ma-2"
                  :color="theme.$secondary_text"
                  icon
                >
                  <send-backward
                    class="control-button edit-icon theme--dark"
                    :style="{ color: theme.$secondary_text }"
                    v-on="on"
                    @click="orderTo('lower')"
                  />
                </v-btn>
              </template>
              <span>На уровень ниже</span>
            </v-tooltip>
          </template>
        </template>
        <v-tooltip
          bottom
          :z-index="fullScreenMode ? 1005 : 100"
          :color="theme.$accent_ui_color"
        >
          <template v-slot:activator="{ on }">
            <v-btn
              class="ma-2"
              :color="theme.$secondary_text"
              icon
            >
              <v-icon
                class="control-button edit-icon theme--dark"
                :style="{ color: theme.$secondary_text }"
                v-on="on"
                @click="fitGraphContent"
              >
                {{ fitToPage }}
              </v-icon>
            </v-btn>
          </template>
          <span>Выровнять по центру</span>
        </v-tooltip>
        <v-tooltip
          bottom
          :z-index="fullScreenMode ? 1005 : 100"
          :color="theme.$accent_ui_color"
        >
          <template v-slot:activator="{ on }">
            <v-btn
              class="ma-2"
              :color="theme.$secondary_text"
              :loading="exportToPDFLoading"
              icon
            >
              <v-icon
                class="control-button edit-icon theme--dark"
                :style="{ color: theme.$secondary_text }"
                v-on="on"
                @click="exportToPDF"
              >
                {{ fileExportPDF }}
              </v-icon>
            </v-btn>
          </template>
          <span>ToPDF</span>
        </v-tooltip>
      </div>
      <div
        class="dash-constructor-schemes__keymap-button"
        :class="{
          'dash-constructor-schemes__keymap-button--x-offset': dataPanel,
        }"
      >
        <v-tooltip
          top
          :z-index="fullScreenMode ? 1005 : 100"
          :nudge-top="5"
          :color="theme.$accent_ui_color"
        >
          <template v-slot:activator="{ on }">
            <button
              v-on="on"
              @click="openKeymapPanel"
            >
              <v-icon
                class="control-button edit-icon theme--dark"
                :style="{ color: theme.$secondary_text }"
              >
                {{ iconHelp }}
              </v-icon>
            </button>
          </template>
          <span>Справка по горячим клавишам</span>
        </v-tooltip>
      </div>
      <!--Keymap-panel-->
      <dash-constructor-schemes-keymap
        :id="idDashFrom"
        ref="keymap"
        v-model="hotkeysPanel"
        @changeKeymapTab="setPanelBottomOffset"
      />
      <!--Drag-and-drop panel-->
      <div
        :ref="`dndPanelContainer-${idFrom}`"
        class="dash-constructor-schemes__dnd-panel-container"
        :style="{
          'bottom': `${panelBottomOffset}px`,
        }"
        :class="{
          'dash-constructor-schemes__dnd-panel-container--active': dndPanel,
        }"
      >
        <div
          v-show="!isLoading"
          :ref="`dndPanel-${idFrom}`"
          class="dash-constructor-schemes__dnd-panel"
        >
          <template v-if="saveMultipleScheme">
            <v-select
              v-model="localActiveSchemeId"
              :items="allSavedSchemes"
              :class="[
                'pt-3',
                'px-0',
                'pb-4',
                'dash-constructor-schemes__select-field',
                'dash-constructor-schemes__select-field--with-padding',
              ]"
              label="Активная схема"
              dense
              :menu-props="{
                'offset-y': true,
                'z-index': 4000,
              }"
            >
              <template #item="{ item, on }">
                <v-list-item
                  ripple
                  class="v-list-item--link"
                  v-on="on"
                >
                  <v-list-item-content>
                    <v-list-item-title
                      :class="[
                        'd-flex',
                        'align-center',
                        'justify-content-between',
                      ]"
                    >
                      <div class="mr-auto">
                        {{ item }}
                      </div>
                      <v-icon
                        class="control-button edit-icon theme--dark"
                        :style="{ color: theme.$secondary_text }"
                        @click.stop="openConfirmDeleteModal(item)"
                      >
                        {{ closeIcon }}
                      </v-icon>
                    </v-list-item-title>
                  </v-list-item-content>
                </v-list-item>
              </template>
            </v-select>
          </template>
          <v-expansion-panels accordion>
            <v-expansion-panel>
              <v-expansion-panel-header
                class="dndPanelItem__group-title"
              >
                Стандартные элементы
              </v-expansion-panel-header>
              <v-expansion-panel-content eager>
                <div
                  :class="[
                    'dndPanelItem__group',
                    'dndPanelItem__group--default-element',
                  ]"
                >
                  <v-expansion-panels>
                    <v-expansion-panel>
                      <v-expansion-panel-header>
                        Настройки:
                      </v-expansion-panel-header>
                      <v-expansion-panel-content>
                        <div class="dash-constructor-schemes__inner-options">
                          <!--TODO: Возможно стоит вынести в отдельный компонент-->
                          <div class="column">
                            <div
                              :style="{
                                border: `1px solid ${theme.$main_border}`,
                                'border-radius': '2px',
                              }"
                              class="row ma-0 mb-2 align-center"
                            >
                              <div
                                class="col-12 text-center"
                                :style="{
                                  'border-bottom': `1px solid ${theme.$main_border}`
                                }"
                              >
                                Линия
                              </div>
                              <!--Цвет линии-->
                              <div class="col-7 text-left">
                                Цвет:
                              </div>
                              <div class="col-5">
                                <v-menu
                                  top
                                  offset-x
                                  :z-index="fullScreenMode ? 1005 : 100"
                                  :close-on-content-click="false"
                                >
                                  <template v-slot:activator="{ on, attrs }">
                                    <v-btn
                                      min-width="100%"
                                      :style="{
                                        // eslint-disable-next-line max-len
                                        'background-color': elementDefaultStyles.edgeStrokeColor.rgbaString,
                                      }"
                                      dark
                                      v-bind="attrs"
                                      v-on="on"
                                    />
                                  </template>

                                  <v-color-picker
                                    :value="elementDefaultStyles.edgeStrokeColor.rgbaObject"
                                    dot-size="12"
                                    mode="rgba"
                                    @update:color="updateDefaultElementColor(
                                      $event,
                                      'edgeStrokeColor'
                                    )"
                                  />
                                </v-menu>
                              </div>
                              <!--Размер линии-->
                              <div class="col-7 text-left">
                                Размер:
                              </div>
                              <div class="col-5">
                                <v-text-field
                                  v-model="elementDefaultStyles.edgeStrokeSize"
                                  outlined
                                  dense
                                  class="dash-constructor-schemes__text-field"
                                />
                              </div>
                              <!--Скругление линии-->
                              <div class="col-7 text-left">
                                Скругление:
                              </div>
                              <div class="col-5">
                                <v-text-field
                                  v-model.number="elementDefaultStyles.edgeSmoothingLength"
                                  dense
                                  outlined
                                  placeholder="Скругление"
                                  class="dash-constructor-schemes__text-field"
                                />
                              </div>
                            </div>
                            <div
                              :style="{
                                border: `1px solid ${theme.$main_border}`,
                                'border-radius': '2px',
                              }"
                              class="row ma-0 mb-2 align-center"
                            >
                              <div
                                class="col-12 text-center"
                                :style="{
                                  'border-bottom': `1px solid ${theme.$main_border}`
                                }"
                              >
                                Блок
                              </div>
                              <!--Фигура-->
                              <div class="col-12">
                                <v-select
                                  v-model="elementDefaultStyles.nodeShape"
                                  :items="shapeNodeStyleList"
                                  class="dash-constructor-schemes__select-field"
                                  item-value="id"
                                  item-text="label"
                                  label="Фигура"
                                />
                              </div>
                              <!--Цвет блока-->
                              <div class="col-7 text-left">
                                Цвет фона:
                              </div>
                              <div class="col-5">
                                <v-menu
                                  top
                                  offset-x
                                  :z-index="fullScreenMode ? 1005 : 100"
                                  :close-on-content-click="false"
                                >
                                  <template v-slot:activator="{ on, attrs }">
                                    <v-btn
                                      min-width="100%"
                                      :style="{
                                        // eslint-disable-next-line max-len
                                        'background-color': elementDefaultStyles.nodeFill.rgbaString,
                                      }"
                                      dark
                                      v-bind="attrs"
                                      v-on="on"
                                    />
                                  </template>

                                  <v-color-picker
                                    :value="elementDefaultStyles.nodeFill.rgbaObject"
                                    dot-size="12"
                                    mode="rgba"
                                    @update:color="updateDefaultElementColor($event, 'nodeFill')"
                                  />
                                </v-menu>
                              </div>
                              <!--Цвет рамки блока-->
                              <div class="col-7 text-left">
                                Цвет рамки:
                              </div>
                              <div class="col-5">
                                <v-menu
                                  top
                                  offset-x
                                  :z-index="fullScreenMode ? 1005 : 100"
                                  :close-on-content-click="false"
                                >
                                  <template v-slot:activator="{ on, attrs }">
                                    <v-btn
                                      min-width="100%"
                                      :style="{
                                        // eslint-disable-next-line max-len
                                        'background-color': elementDefaultStyles.nodeStrokeColor.rgbaString,
                                      }"
                                      dark
                                      v-bind="attrs"
                                      v-on="on"
                                    />
                                  </template>

                                  <v-color-picker
                                    :value="elementDefaultStyles.nodeStrokeColor.rgbaObject"
                                    dot-size="12"
                                    mode="rgba"
                                    @update:color="updateDefaultElementColor(
                                      $event,
                                      'nodeStrokeColor'
                                    )"
                                  />
                                </v-menu>
                              </div>
                              <!--Размер рамки блока-->
                              <div class="col-7 text-left text-no-wrap">
                                Размер рамки:
                              </div>
                              <div class="col-5">
                                <v-text-field
                                  v-model="elementDefaultStyles.nodeStrokeSize"
                                  dense
                                  outlined
                                  class="dash-constructor-schemes__text-field"
                                />
                              </div>
                            </div>
                            <div class="col-12 text-left">
                              <v-btn
                                outlined
                                small
                                :color="theme.$main_text"
                                class="dash-constructor-schemes__apply-options"
                                @click="applyOptions"
                              >
                                Применить
                              </v-btn>
                            </div>
                          </div>
                        </div>
                      </v-expansion-panel-content>
                    </v-expansion-panel>
                  </v-expansion-panels>
                  <div class="dndPanelItem__group-items" />
                </div>
              </v-expansion-panel-content>
            </v-expansion-panel>
            <v-expansion-panel>
              <v-expansion-panel-header
                class="dndPanelItem__group-title"
              >
                Блоки с данными
              </v-expansion-panel-header>
              <v-expansion-panel-content eager>
                <div class="dndPanelItem__group dndPanelItem__group--data-node">
                  <div class="dndPanelItem__group-items" />
                </div>
              </v-expansion-panel-content>
            </v-expansion-panel>
            <v-expansion-panel>
              <v-expansion-panel-header
                class="dndPanelItem__group-title"
              >
                Текстовые блоки
              </v-expansion-panel-header>
              <v-expansion-panel-content eager>
                <div class="dndPanelItem__group dndPanelItem__group--text-node">
                  <div class="dndPanelItem__group-items" />
                </div>
              </v-expansion-panel-content>
            </v-expansion-panel>
            <v-expansion-panel>
              <v-expansion-panel-header
                class="dndPanelItem__group-title"
              >
                Изображения\иконки
              </v-expansion-panel-header>
              <v-expansion-panel-content eager>
                <div class="dndPanelItem__group dndPanelItem__group--image-node">
                  <div class="dndPanelItem__group-items" />
                </div>
              </v-expansion-panel-content>
            </v-expansion-panel>
            <v-expansion-panel>
              <v-expansion-panel-header class="dndPanelItem__group-title">
                Порты
              </v-expansion-panel-header>
              <v-expansion-panel-content eager>
                <div class="dndPanelItem__group dndPanelItem__group--port-node">
                  <div class="dndPanelItem__group-items" />
                </div>
              </v-expansion-panel-content>
            </v-expansion-panel>
          </v-expansion-panels>
        </div>
        <div
          v-show="isLoading"
          class="dash-constructor-schemes__loading-circular"
        >
          <v-progress-circular
            indeterminate
            size="50"
            :color="theme.$accent_ui_color"
          />
        </div>
      </div>
      <!--Settings-element-panel-->
      <div
        class="dash-constructor-schemes__data-panel pr-0"
        :class="{
          'dash-constructor-schemes__data-panel--active': dataPanel,
        }"
      >
        <div class="row">
          <div class="col-12">
            <div
              class="d-flex justify-content-right"
            >
              <button @click="closeDataPanel">
                <v-icon
                  class="control-button edit-icon theme--dark"
                  :style="{ color: theme.$secondary_text }"
                >
                  {{ closeIcon }}
                </v-icon>
              </button>
            </div>
          </div>
        </div>
        <dash-constructor-schemes-settings
          v-model="dataSelectedNode"
          :theme="theme"
          :data-rest-from="dataRestFrom"
          :shape-node-style-list="shapeNodeStyleList"
          @changeDataSelectedNode="changeDataSelectedNode"
        />
      </div>
      <!--The GraphComponent-->
      <component
        :is="'div'"
        :ref="`graphComponent-${idFrom}`"
        class="dash-constructor-schemes__graph-component"
      />
      <modal-confirm
        v-model="isConfirmModal"
        :theme="theme"
        :modal-text="`Все элементы на визуализации будут удалены. Продолжить ?`"
        btn-confirm-text="Да"
        btn-cancel-text="Нет"
        @result="startSearch"
      />
      <modal-confirm
        v-model="isConfirmModalDelete"
        :theme="theme"
        :modal-text="`Удалить выбранную схему из списка сохраненных ?`"
        btn-confirm-text="Да"
        btn-cancel-text="Нет"
        @result="deleteSavedScheme"
      />
    </div>
  </portal>
</template>

<script>
import {
  mdiArrowDown,
  mdiArrowUp,
  mdiClose,
  mdiArrowCollapseLeft,
  mdiArrowCollapseRight,
  mdiSettings,
  mdiHelp,
  mdiFitToPageOutline,
  mdiCloudDownloadOutline,
  mdiFileImport,
  mdiFileExport,
  mdiFilePdf,
} from '@mdi/js';
import BringForward from '../../../images/bring_forward.svg';
import BringToFront from '../../../images/bring_to_front.svg';
import SendBackward from '../../../images/send_backward.svg';
import SendToBack from '../../../images/send_to_back.svg';

import ConstructorSchemesClass from '../../../js/classes/ConstructorSchemes/ConstructorSchemesClass';
import { throttle } from '@/js/utils/throttle';
import elementTemplates from '@/js/classes/ConstructorSchemes/elementTemplates';

export default {
  name: 'DashConstructorSchemes',
  components: {
    BringForward,
    BringToFront,
    SendBackward,
    SendToBack,
  },
  props: {
    // id элемента (constructor-schemes-1\2\3...)
    idFrom: {
      type: String,
      required: true,
    },
    // id дашборда
    idDashFrom: {
      type: String,
      required: true,
    },
    // данные с сервера
    dataRestFrom: {
      type: Array,
      default: () => ([]),
    },
    // размеры визуализации(width, height)
    sizeFrom: {
      type: Object,
      required: true,
    },
    // Полноэкранный режим
    fullScreenMode: {
      type: Boolean,
      default: false,
    },
    // Список источников данных
    dataSources: {
      type: Object,
      default: () => ({}),
    },
    customStyle: {
      type: Object,
      default: () => ({}),
    },
    customClass: {
      type: String,
      default: '',
    },
  },
  data() {
    return {
      actions: [
        { name: 'click:label', capture: ['value1', 'value2', 'value3', 'value4', 'value5'] },
      ],
      isEdit: false,
      gear: mdiSettings,
      closeIcon: mdiClose,
      arrowUp: mdiArrowUp,
      arrowCollapseLeft: mdiArrowCollapseLeft,
      arrowCollapseRight: mdiArrowCollapseRight,
      fileImportOutline: mdiFileImport,
      fileExportOutline: mdiFileExport,
      fileExportPDF: mdiFilePdf,
      iconArrowUp: '/icons/OrderIcons/bring_to_front.svg',
      arrowDown: mdiArrowDown,
      iconHelp: mdiHelp,
      cloudDownloadOutlineIcon: mdiCloudDownloadOutline,
      fitToPage: mdiFitToPageOutline,
      nodeBgColorPopup: false,
      nodeBorderColorPopup: false,
      shapeNodeStyle: '',
      shapeNodeStyleList: [],
      elementDefaultStyles: {
        labelFont: `12px ${elementTemplates.fontFamily}`,
        labelTextFill: {
          rgbaString: 'rgba(255, 255, 255, 255)',
          rgbaObject: {
            r: 255,
            g: 255,
            b: 255,
            a: 255,
          },
        },
        nodeFill: {
          rgbaString: 'rgba(255, 255, 255, 255)',
          rgbaObject: {
            r: 255,
            g: 255,
            b: 255,
            a: 255,
          },
        },
        nodeStrokeColor: {
          rgbaString: 'rgba(255, 255, 255, 255)',
          rgbaObject: {
            r: 255,
            g: 255,
            b: 255,
            a: 255,
          },
        },
        nodeStrokeSize: '1.5px',
        nodeShape: 0,
        edgeStrokeColor: {
          rgbaString: 'rgba(255, 255, 255, 255)',
          rgbaObject: {
            r: 255,
            g: 255,
            b: 255,
            a: 255,
          },
        },
        edgeStrokeSize: '10px',
        edgeSmoothingLength: 0,
      },
      allItems: [],
      selectedNode: '',
      selectedDataType: '',
      dataSelectedNode: null,
      panelBottomOffset: 10,
      isLoading: false,
      // Default value - graph
      // activeScheme: 'graph',
      timeout: null,
      timer: 0,
      schemeIdForDelete: '',
      localActiveSchemeId: '',
      file: null,
      isConfirmModal: false,
      isConfirmUpdateScheme: false,
      isConfirmModalDelete: false,
      // Panels
      dndPanel: false,
      dataPanel: false,
      hotkeysPanel: false,
      exportToPDFLoading: false,
    };
  },
  computed: {
    dndPanelId() {
      return `dndPanel-${this.idFrom}`;
    },
    schemeElementId() {
      return `graphComponent-${this.idFrom}`;
    },
    dashFromStore() {
      return this.$store.state[this.idDashFrom];
    },
    visualisationFromStore() {
      return this.dashFromStore[this.idFrom];
    },
    optionsFromStore() {
      return this.visualisationFromStore.options;
    },
    dashboardEditMode() {
      return this.dashFromStore.editMode;
    },
    primitivesFromStore() {
      if (this.optionsFromStore?.primitivesLibrary) {
        return JSON.parse(this.optionsFromStore.primitivesLibrary)
          .map((iconName) => ({
            icon: iconName,
          }));
      }
      return [];
    },
    // old
    savedGraph() {
      if (this.dashFromStore?.savedGraph) {
        return this.dashFromStore.savedGraph;
      }
      return this.visualisationFromStore?.savedGraph || '';
    },
    savedGraphObject() {
      if (!this.visualisationFromStore?.savedGraphObject) {
        // this.localActiveSchemeId = this.activeSchemeId || 'default-scheme';
        this.createSavedGraphObjectField();
      }
      const savedGraph = this.visualisationFromStore.savedGraphObject;
      if (savedGraph) {
        return savedGraph[this.localActiveSchemeId] || [];
      }
      return [];
    },
    tokenActionsByElType() {
      const filteredSavedElements = this.savedGraphObject
        .filter((el) => el.data?.tag?.fromOtl);

      if (filteredSavedElements.length === 0) {
        return [];
      }
      const actionsNameArr = [];
      const result = filteredSavedElements.reduce((acc, el) => {
        const { type } = el.data.tag.fromOtl;
        const parentCapture = el.data.tag.fromOtl.parent_capture;
        const childCapture = el.data.tag.fromOtl.child_capture;

        const capture = (captureString) => (
          captureString && typeof captureString === 'string'
            ? captureString.split(',')
            : Object.keys(el.data.tag.fromOtl)
        );

        acc.push({
          name: type
            ? `click:el-parent-${type}`
            : 'click:el-other',
          capture: capture(parentCapture),
        });

        if (type) {
          const allChildCapture = childCapture
            ? [...new Set(childCapture.split(','))]
            : [];
          if (allChildCapture.length > 0) {
            acc.push({
              name: `click:el-child-${type}`,
              capture: allChildCapture,
            });
          }
          acc.push({
            name: 'click:el-child',
            capture: Object.keys(el.data.tag.fromOtl),
          });
        }

        return acc;
      }, []);
      const filteredResult = [];
      result.forEach((el) => {
        if (!actionsNameArr.includes(el.name)) {
          actionsNameArr.push(el.name);
          filteredResult.push(el);
        }
      });
      return filteredResult;
    },
    innerSize() {
      return {
        height: this.sizeFrom.height - 32,
        width: this.sizeFrom.width,
      };
    },
    theme() {
      return this.$store.getters.getTheme;
    },
    searchForBuildScheme() {
      return this.optionsFromStore.searchForBuildScheme;
    },
    dataForBuildScheme() {
      if (this.searchForBuildScheme) {
        return this.dataSources[this.searchForBuildScheme]?.data || [];
      }
      return [];
    },
    loadingSearchForBuildScheme() {
      return this.dashFromStore.searches
        .find((search) => search.id === this.searchForBuildScheme)
        ?.status === 'pending';
    },
    isPanelBackHide() {
      return this.optionsFromStore?.panelBackHide || false;
    },
    isBridgeEnable() {
      return this.optionsFromStore?.isBridgeEdgeSupport || false;
    },
    isAlwaysUpdateScheme() {
      return this.optionsFromStore?.alwaysUpdateScheme || false;
    },
    saveMultipleScheme() {
      return this.optionsFromStore?.saveMultipleScheme;
    },
    minimumLastSegmentLength() {
      return Number(this.optionsFromStore.minimumLastSegmentLength) || 30;
    },
    minimumEdgeToEdgeDistance() {
      return Number(this.optionsFromStore.minimumEdgeToEdgeDistance) || 10;
    },
    activeSchemeId() {
      const hasValidData = this.saveMultipleScheme
          && this.optionsFromStore?.tokensBySchemeId?.length > 0
          && this.dashFromStore?.tockens?.length > 0;

      if (hasValidData) {
        return this.optionsFromStore.tokensBySchemeId
          .map((tokenName) => {
            const tokenByName = this.dashFromStore.tockens.find((el) => el.name === tokenName);
            return tokenByName && 'value' in tokenByName ? tokenByName.value : null;
          })
          .filter((value) => value !== null)
          .join('-')
          .replace(/\s/g, '_') || 'default-scheme';
      }

      return 'default-scheme';
    },
    allSavedSchemes() {
      if (this.visualisationFromStore?.savedGraphObject) {
        return Object.keys(this.visualisationFromStore.savedGraphObject);
      }
      return [];
    },
    getNameForExporter() {
      return this.localActiveSchemeId === 'default-scheme'
        || this.localActiveSchemeId === ''
        ? this.visualisationFromStore.name_elem
        : this.localActiveSchemeId;
    },
  },
  watch: {
    'theme.$secondary_bg': {
      handler(val) {
        this.constructorSchemes.setExporterOptions({ background: val.$secondary_bg });
      },
    },
    file(value) {
      if (value) {
        this.importFrom(value);
      }
    },
    primitivesFromStore: {
      handler() {
        this.constructorSchemes.refreshDnDPanel(this.primitivesFromStore);
      },
      deep: true,
    },
    dataRestFrom(value) {
      if (this.constructorSchemes && value?.length > 0) {
        this.constructorSchemes.updateDataRest(structuredClone(value));
        this.constructorSchemes.updateDataInNode(structuredClone(value));
      }
    },
    hotkeysPanel(val) {
      if (val) {
        this.closePanels(['hotkeysPanel']);
      }
      this.setPanelBottomOffset();
    },
    fullScreenMode() {
      this.closePanels();
      this.$nextTick(() => {
        this.$nextTick(() => {
          this.createGraph();
          this.updateDefaultElementColor = throttle(this.updateDefaultElementColor, 200);
          this.updateSavedGraph = throttle(this.updateSavedGraph, 1000);
        });
      });
    },
    dashboardEditMode(val) {
      this.isEdit = val;
      this.toggleInputMode();
    },
    dataForBuildScheme(value) {
      if (this.isAlwaysUpdateScheme && value?.length > 0) {
        this.constructorSchemes.buildSchemeFromSearch(
          {
            dataFrom: value,
            minimumEdgeToEdgeDistance: this.minimumEdgeToEdgeDistance,
            minimumLastSegmentLength: this.minimumLastSegmentLength,
          },
        );
      }
    },
    activeSchemeId(schemeId) {
      this.localActiveSchemeId = schemeId;
      if (!this.savedGraphObject[schemeId]) {
        this.updateSavedGraphObject([]);
      }
    },
    localActiveSchemeId() {
      if (this.constructorSchemes) {
        this.constructorSchemes.update(this.savedGraphObject);
        this.constructorSchemes.setExporterOptions({ fileName: this.getNameForExporter });
      }
    },
    loadingSearchForBuildScheme(val) {
      this.toggleLoading(val);
    },
    dataSelectedNode(node) {
      if (node?.dataType === 'image-node' && this.dataForBuildScheme?.length > 0) {
        this.actions = this.actions.map((action) => {
          if (action.name !== 'click:image') {
            return action;
          }
          return {
            ...action,
            capture: Object.keys(node),
          };
        });
      }
    },
    tokenActionsByElType(value) {
      if (this.dataForBuildScheme?.length > 0) {
        this.actions = [
          { name: 'click:label', capture: ['value1', 'value2', 'value3', 'value4', 'value5'] },
          ...value,
        ];
        this.setActions();
      }
    },
    actions: {
      deep: true,
      handler(val) {
        const test = [];
        val.forEach((el) => {
          if (!test.includes(el.name)) {
            test.push(el.name);
          }
        });
      },
    },
  },
  created() {
    // if (!this.savedGraphObject) {
    //   this.localActiveSchemeId = this.activeSchemeId || 'default-scheme';
    // this.createSavedGraphObjectField();
    // }
  },
  mounted() {
    this.createGraph();
    this.updateDefaultElementColor = throttle(this.updateDefaultElementColor, 200);
    this.updateSavedGraph = throttle(this.updateSavedGraph, 1000);
    this.setActions();
    this.localActiveSchemeId = this.activeSchemeId;
    this.isEdit = this.dashboardEditMode;
    if (this.constructorSchemes) {
      if (this.isAlwaysUpdateScheme && this.dataForBuildScheme?.length > 0) {
        this.constructorSchemes.buildSchemeFromSearch({
          dataFrom: this.dataForBuildScheme,
          minimumLastSegmentLength: this.minimumLastSegmentLength,
          minimumEdgeToEdgeDistance: this.minimumEdgeToEdgeDistance,
        });
      } else {
        this.constructorSchemes.update(this.savedGraphObject);
      }
    }
  },
  methods: {
    closePanels(exceptions) {
      const panels = ['dndPanel', 'dataPanel', 'hotkeysPanel'];
      panels.forEach((panelName) => {
        if (exceptions) {
          if (!exceptions.includes(panelName)) {
            this[panelName] = false;
          }
        } else {
          this[panelName] = false;
        }
      });
    },
    setActions() {
      this.$store.commit('setActions', {
        actions: JSON.parse(JSON.stringify(this.actions)),
        idDash: this.idDashFrom,
        id: this.idFrom,
      });
    },
    getEvents({ event }) {
      let result = [];
      if (!this.dashFromStore.events) {
        this.$store.commit('setState', [{
          object: this.dashFromStore,
          prop: 'events',
          value: [],
        }]);
        return [];
      }
      result = this.dashFromStore.events.filter((item) => (
        item.event === event
          && item.element.indexOf(`${this.idFrom}:`) !== -1
          && item.partelement === 'empty'
      ));
      return result;
    },
    updateDefaultElementColor(evt, field) {
      const updateValue = structuredClone(this.elementDefaultStyles);
      updateValue[field] = {
        rgbaObject: evt.rgba,
        rgbaString: `rgba(${evt.rgba.r}, ${evt.rgba.g}, ${evt.rgba.b}, ${evt.rgba.a})`,
      };
      this.elementDefaultStyles = updateValue;
    },
    applyOptions() {
      this.constructorSchemes.applyStylesElements(this.elementDefaultStyles);
    },
    toggleDnDPanel() {
      this.dndPanel = !this.dndPanel;
      this.closePanels(['dataPanel', 'dndPanel']);
    },
    toggleLoading(isLoading) {
      this.$emit('setLoading', isLoading);
      this.isLoading = isLoading;
    },
    createGraph() {
      this.constructorSchemes = new ConstructorSchemesClass({
        dndPanelElem: this.$refs[this.dndPanelId],
        schemeId: this.idFrom,
        elem: this.$refs[this.schemeElementId],
        dataRest: this.dataRestFrom,
        iconsList: this.primitivesFromStore,
        openDataPanelCallback: this.openDataPanel,
        closeDataPanelCallback: this.closeDataPanel,
        savedGraph: this.savedGraph,
        savedGraphObject: this.savedGraphObject,
        updateStoreCallback: this.updateSavedGraph,
        updateStoreCallbackV2: this.updateSavedGraphObject,
        toggleLoadingCallback: this.toggleLoading,
        isEdit: this.dashboardEditMode,
        isBridgesEnable: this.isBridgeEnable,
        exporterOptions: {
          fileName: this.getNameForExporter,
          background: this.theme.$secondary_bg,
        },
        onClickObject: (type, data) => {
          if (!type || (!type.includes('label-type') && type !== 'image-node')) {
            return;
          }
          let actions = [];
          if (type === 'image-node') {
            if (data.fromOtl.token_type) {
              const tokenType = data.fromOtl.token_type;
              const [element, groupWithCount] = tokenType.split('-');
              const [group] = groupWithCount.split('_');
              actions.push(`click:el-${element}`);
              if (group) {
                actions.push(`click:el-${element}-${group}`);
              }
            }
          } else {
            actions = this.addTokenTypeActions(
              this.getActions(type, 'click'),
              data,
            );
          }
          this.$store.commit('tokenAction', {
            idDash: this.idDashFrom,
            elem: this.idFrom,
            action: actions,
            value: data?.fromOtl || data,
          });

          const events = this.getEvents({ event: 'onclick' });
          this.processEvents(events, data);
        },
      });
      if (this.constructorSchemes) {
        this.shapeNodeStyleList = this.constructorSchemes.getShapeNodeStyleList;
        this.nodeShape = this.constructorSchemes.defaultNodeStyle.shape;
        this.applyOptions();
      }
    },
    getActions(typeString, prefix) {
      return typeString.split('-').reduce((acc, item, idx) => {
        if (idx > 0) {
          acc.push(`${acc[idx - 1]}-${item}`);
        } else {
          acc.push(`${prefix}:${item}`);
        }
        return acc;
      }, []);
    },
    addTokenTypeActions(actions, data) {
      if (data?.fromOtl?.token_type) {
        const tokenTypeSplited = data.fromOtl.token_type.split('-');
        const extActions = this.getActions(tokenTypeSplited.join('-'), 'click:el');
        return [...new Set([...actions, ...extActions])];
      }
      return actions;
    },
    processEvents(events, data) {
      if (events.length !== 0) {
        events.forEach((event) => {
          const fieldName = event.element.match(/:label-(\w+)/);
          if (event.action === 'go' && fieldName && data[fieldName[1]]) {
            this.$store.dispatch('letEventGo', {
              event,
              idDash: this.idDashFrom,
              route: this.$router,
              store: this.$store,
              id: this.idFrom,
            });
          }
        });
      }
    },
    changeDataSelectedNode(updatedData) {
      this.$nextTick().then(() => {
        this.constructorSchemes.updateSelectedNode(
          updatedData,
          this.updateSavedGraph,
        );
      });
    },
    updateSavedGraph(data) {
      if (this.savedGraph) {
        this.$store.commit('setState', [{
          object: this.visualisationFromStore,
          prop: 'savedGraph',
          value: data,
        }]);
      }
      this.$store.commit('setState', [{
        object: this.visualisationFromStore,
        prop: 'savedGraph',
        value: data,
      }]);
    },
    createSavedGraphObjectField() {
      if (!this.visualisationFromStore?.savedGraphObject) {
        this.$store.commit('setState', [{
          object: this.visualisationFromStore,
          prop: 'savedGraphObject',
          value: {},
        }]);
      }
      if (!this.visualisationFromStore.savedGraphObject[this.localActiveSchemeId]) {
        this.$store.commit('setState', [{
          object: this.visualisationFromStore.savedGraphObject,
          prop: this.localActiveSchemeId || 'default-scheme',
          value: [],
        }]);
      }
    },
    clearSavedGraphObject() {
      this.$store.commit('setState', [{
        object: this.visualisationFromStore.savedGraphObject,
        prop: this.localActiveSchemeId,
        value: [],
      }]);
    },
    updateSavedGraphObject(data) {
      if (this.timeout) {
        clearTimeout(this.timeout);
      }
      this.timer = 500;
      this.timeout = setTimeout(() => {
        this.createSavedGraphObjectField();
        this.$store.commit('setState', [{
          object: this.visualisationFromStore.savedGraphObject,
          prop: this.localActiveSchemeId,
          value: data,
        }]);
        if (this.savedGraph) {
          this.updateSavedGraph('');
        }
      }, this.timer);
    },
    closeDataPanel() {
      this.dataPanel = false;
      this.selectedNode = '';
      this.selectedDataType = '';
      this.dataSelectedNode = null;
    },
    openDataPanel(targetElement) {
      new Promise((resolve) => {
        this.closeDataPanel();
        this.selectedNode = structuredClone(targetElement.nodeId);
        this.dataSelectedNode = structuredClone(targetElement);
        if (targetElement.dataType) {
          this.selectedDataType = structuredClone(targetElement.dataType);
        } else {
          this.selectedDataType = 'default-node';
        }
        resolve();
      }).then(() => {
        if (targetElement.dataType !== 'image-node') {
          this.dataPanel = true;
          this.closePanels(['dndPanel', 'dataPanel']);
        }
      });
    },
    orderTo(key) {
      this.constructorSchemes.orderTo(key);
    },
    addLine() {
      this.dataSelectedNode.items.push({
        id: '',
        textLeft: 'Label',
        textRight: 'Value',
      });
      this.changeDataSelectedNode();
    },
    deleteLine(index) {
      this.dataSelectedNode.items.splice(index, 1);
      this.changeDataSelectedNode();
    },
    toggleInputMode() {
      if (this.constructorSchemes) {
        this.isEdit = this.constructorSchemes.toggleInputMode();
        // this.localActiveSchemeId = this.activeSchemeId;
        if (!this.isEdit) {
          this.closeDataPanel();
          this.dndPanel = false;
        }
      }
    },
    openKeymapPanel() {
      this.hotkeysPanel = true;
    },
    setPanelBottomOffset() {
      this.$nextTick().then(() => {
        this.panelBottomOffset = this.hotkeysPanel ? this.$refs.keymap.$el.clientHeight + 5 : 10;
      });
    },
    fitGraphContent() {
      this.constructorSchemes.fitGraphContent();
    },
    async exportToPDF() {
      this.exportToPDFLoading = true;
      await this.constructorSchemes.exportToPDF();
      this.exportToPDFLoading = false;
    },
    openConfirmModal() {
      this.isConfirmModal = true;
    },
    async startSearch(confirm) {
      if (confirm) {
        this.constructorSchemes.buildSchemeFromSearch(this.dataForBuildScheme);
      }
    },
    openConfirmDeleteModal(schemeIdForDelete) {
      this.schemeIdForDelete = schemeIdForDelete;
      this.isConfirmModalDelete = true;
    },
    deleteSavedScheme(isCancelDelete) {
      if (isCancelDelete) {
        const deleteFn = (object, fieldsForDelete) => {
          const result = {};
          Object.keys(object).forEach((key) => {
            if (!fieldsForDelete.includes(key)) {
              result[key] = object[key];
            }
          });
          return result;
        };
        const allSchemes = structuredClone(this.savedGraphObject);
        const filteredSavedSchemes = deleteFn(allSchemes, [this.schemeIdForDelete]);
        this.$store.commit('setState', [{
          object: this.dashFromStore[this.idFrom],
          prop: 'savedGraphObject',
          value: filteredSavedSchemes,
        }]);
        this.schemeIdForDelete = '';
      } else {
        this.schemeIdForDelete = '';
      }
    },
    exportJSON() {
      const schemeId = `dash_${this.idDashFrom}_${this.idFrom}_${this.localActiveSchemeId}`;
      this.constructorSchemes.exportGraphToJSON(schemeId, this.savedGraphObject);
    },
    importFrom(file) {
      this.clearSavedGraphObject();
      this.constructorSchemes.importGraphFromJSON(file);
      this.file = null;
    },
    updateFile(e) {
      if (e) {
        this.file = e;
        this.$nextTick(() => {
          this.$refs.fileInput.$refs.input.value = '';
        });
      }
    },
  },
};
</script>

<style lang="scss" scoped>

.dash-constructor-schemes {
  position: relative;
  overflow: hidden;
  &__text-field, &__select-field {
    ::v-deep.v-text-field__details {
      display: none;
    }

  }
  &__text-field {
    ::v-deep.theme--light.v-input {
      color: var(--main_text);
      .v-icon {
        color: var(--main-text);
      }
    }
  }
  &__select-field {
    &--with-padding {
      padding-left: 10px;
      padding-right: 10px;
    }
    ::v-deep {
      &.v-input__control, .v-icon__svg {
        caret-color: var(--main_text) !important;
        color: var(--main_text) !important;
        border-color: var(--main_text) !important;
      }
    }
  }
  &__switch {
    padding-left: 20px;
    ::v-deep.v-input__control {
      .v-input__slot {
        .v-input--selection-controls__input {
          .v-input--switch__track {
            color: var(--secondary_text);
          }
        }
      }
    }
  }
  &__file-input {
    ::v-deep.v-input__prepend-outer {
      margin: 0 auto !important;
      .v-icon__svg {
        fill: var(--secondary_text);
      }
    }
  }
  &__loading-circular {
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  &__options {
    position: absolute;
    left: 0;
    top: 5px;
    display: flex;
    align-items: center;
    z-index: 10;
    padding-right: 5px;
    transition: all .2s ease;
    border-radius: 4px;
    overflow: hidden;
    &--edit-mode {
      &::before {
        content: "";
        position: absolute;
        pointer-events: none;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        transition: all .2s ease;
        background-color: var(--main_bg);
        opacity: .8;
        z-index: -1;
      }
    }

    &--dnd-panel-is-open {
      left: 264px;
    }
  }
  &__inner-options {
    display: flex;
    align-items: center;
  }
  &__keymap-button {
    position: absolute;
    right: 20px;
    bottom: 20px;
    z-index: 1;
    border-radius: 50%;
    background-color: var(--main_bg);
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: .8;
    transition: all .2s ease;
    &--x-offset {
      right: 310px;
    }
  }
  &__color-button {
    width: 100%;
    height: 30px;
  }
  &__relative-wrapper {
    position: relative;
  }
  &__color-picker {
    position: absolute;
    pointer-events: none;
    opacity: 0;
    width: 230px;
    &--active {
      z-index: 1;
      opacity: 1;
      pointer-events: all;
      left: -170px;
    }
  }
  &__dnd-panel-container, &__data-panel {
    color: var(--main_text);
    z-index: 10;
    position: absolute;
    top: 5px;
    bottom: 15px;
    background-color: var(--main_bg);
    width: 260px;
    padding: 10px;
    transition: all .2s ease;
    pointer-events: none;
    max-height: inherit;
    overflow-y: auto;
    overflow-x: hidden;
  }
  &__dnd-panel-container {
    left: 0;
    border-radius: 0 4px 4px 0;
    transition: all .2s ease;
    transform: translateX(-100%);
    &--active {
      transform: translateX(0);
      pointer-events: all;
    }
    &--is-keymap-open {
      bottom: 405px;
    }
  }
  &__data-panel {
    overflow: hidden;
    right: 0;
    width: 300px;
    transform: translateX(100%);
    border-radius: 4px 0 0 4px;
    &--active {
      transform: translateX(0);
      pointer-events: all;
    }
    &-wrapper {
      padding-top: 10px;
    }
  }
  &__graph-component {
    height: inherit;
  }
  &__dnd-panel ::v-deep {
    .v-expansion-panel {
      background-color: var(--main_bg) !important;
      color: var(--main_text) !important;
      &::before {
        box-shadow: none;
      }
    }
    .v-expansion-panel-content__wrap {
      padding-left: 0;
      padding-right: 0;
    }
    .v-expansion-panel-header {
      padding-left: 0;
      padding-right: 0;
    }
    .v-expansion-panels {
      .v-expansion-panel-header__icon  {
        .v-icon {
          color: var(--main_text) !important;
        }
      }
    }

  }
}
</style>

<style lang="scss">
.b-data-node {
  &__text {
    font-weight: 700;
    line-height: 1;
  }
  &__wrapper {
    &--type-2 {
      display: flex;
      height: 100%;
      text-align: center;
      font-weight: 700;
      font-size: 11px;
      line-height: 13px;
      color: #FFFFFF;
      box-sizing: border-box;
      justify-content: center;
      align-items: center;
      padding: 7.5px 12px;
    }
  }
}
.yfiles-snap-line {
  stroke: #ff0000 !important;
}
</style>
